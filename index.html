<!DOCTYPE html>
<html>
<head>
    <title>PDEåˆ†æå·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 30px; 
            background: linear-gradient(to bottom, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin-bottom: 30px;
            font-size: 2em;
        }
        .input-section { 
            margin: 30px 0; 
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        label { 
            font-weight: 600; 
            margin-bottom: 8px; 
            color: #495057;
            display: block;
        }
        select, input[type="file"] {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .button-container {
            text-align: center;
            margin: 30px 0;
        }
        button { 
            padding: 12px 40px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .result-section {
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 8px;
            color: white;
            text-align: center;
        }
        .result { 
            font-size: 1.5em; 
            font-weight: 600;
        }
        #pdeResult {
            font-size: 1.8em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        #plot { 
            margin-top: 30px; 
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        #plot img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .info-text {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        h3 {
            color: #495057;
            margin-bottom: 15px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #667eea;
            font-weight: 600;
        }
        .loading.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ é—ªçƒä½“ä¸SiPMçš„PDEåˆ†æå·¥å…·</h1>
        
        <div class="input-section">
            <h3>ğŸ“Š æ•°æ®è¾“å…¥é…ç½®</h3>
            <div class="input-row">
                <div class="input-group">
                    <label>é—ªçƒä½“å‘å°„å…‰è°± (Scintillator Emission):</label>
                    <select id="scinPreset" onchange="updateScinSource()">
                        <option value="">é€‰æ‹©é¢„è®¾...</option>
                        <option value="GAGG">GAGG (Ce-doped GAGG)</option>
                        <option value="BC408">BC408 (Plastic Scintillator)</option>
                        <option value="custom">ä¸Šä¼ è‡ªå®šä¹‰æ–‡ä»¶...</option>
                    </select>
                    <input type="file" id="eFile" accept=".csv" style="display:none; margin-top: 10px;">
                    <div class="info-text">é€‰æ‹©é¢„è®¾é—ªçƒä½“æˆ–ä¸Šä¼ CSVæ–‡ä»¶</div>
                </div>
                
                <div class="input-group">
                    <label>SiPMå…‰ç”µæ¢æµ‹æ•ˆç‡ (SiPM PDE):</label>
                    <select id="sipmPreset" onchange="updateSipmSource()">
                        <option value="">é€‰æ‹©é¢„è®¾...</option>
                        <option value="60035_2.5V">SensL 60035 @ 2.5V</option>
                        <option value="custom">ä¸Šä¼ è‡ªå®šä¹‰æ–‡ä»¶...</option>
                    </select>
                    <input type="file" id="aFile" accept=".csv" style="display:none; margin-top: 10px;">
                    <div class="info-text">é€‰æ‹©é¢„è®¾SiPMæˆ–ä¸Šä¼ CSVæ–‡ä»¶</div>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button onclick="processData()" id="calcButton">ğŸ§® è®¡ç®—å¹¶å¯è§†åŒ–</button>
        </div>
        
        <div class="loading" id="loading">
            â³ æ­£åœ¨è®¡ç®—ä¸­...
        </div>
        
        <div class="result-section" style="display:none;" id="resultSection">
            <div class="result">
                å…‰ç”µæ¢æµ‹æ•ˆç‡ï¼ˆPDEï¼‰: <span id="pdeResult">--</span>
            </div>
        </div>
        
        <div id="plot"></div>
    </div>

    <script>
        let pyodide;
        let pyodideReady = false;
        
        async function setupPyodide() {
            try {
                document.getElementById('calcButton').disabled = true;
                document.getElementById('calcButton').textContent = 'â³ åˆå§‹åŒ–Pythonç¯å¢ƒ...';
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
                });
                await pyodide.loadPackage(["numpy", "matplotlib"]);
                pyodideReady = true;
                document.getElementById('calcButton').disabled = false;
                document.getElementById('calcButton').textContent = 'ğŸ§® è®¡ç®—å¹¶å¯è§†åŒ–';
            } catch (error) {
                alert('åˆå§‹åŒ–Pythonç¯å¢ƒå¤±è´¥: ' + error);
            }
        }
        setupPyodide();

        function updateScinSource() {
            const preset = document.getElementById('scinPreset').value;
            const fileInput = document.getElementById('eFile');
            if (preset === 'custom') {
                fileInput.style.display = 'block';
            } else {
                fileInput.style.display = 'none';
            }
        }

        function updateSipmSource() {
            const preset = document.getElementById('sipmPreset').value;
            const fileInput = document.getElementById('aFile');
            if (preset === 'custom') {
                fileInput.style.display = 'block';
            } else {
                fileInput.style.display = 'none';
            }
        }

        async function loadPresetCSV(path) {
            try {
                const response = await fetch(path);
                const text = await response.text();
                return text.split('\n')
                    .map(line => line.trim())
                    .filter(line => line)
                    .map(line => line.split(',').map(v => parseFloat(v.trim())))
                    .filter(arr => arr.length === 2 && !isNaN(arr[0]) && !isNaN(arr[1]));
            } catch (error) {
                throw new Error(`åŠ è½½é¢„è®¾æ–‡ä»¶å¤±è´¥ (${path}): ${error.message}`);
            }
        }

        async function processData() {
            if (!pyodideReady) {
                alert("Pythonç¯å¢ƒå°šæœªå‡†å¤‡å¥½ï¼Œè¯·ç¨å€™...");
                return;
            }

            const scinPreset = document.getElementById('scinPreset').value;
            const sipmPreset = document.getElementById('sipmPreset').value;
            
            if (!scinPreset || !sipmPreset) {
                alert("è¯·é€‰æ‹©é—ªçƒä½“å’ŒSiPMæ•°æ®æº");
                return;
            }

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('calcButton').disabled = true;
            document.getElementById('resultSection').style.display = 'none';

            try {
                let eData, aData;

                // Load scintillator data
                if (scinPreset === 'custom') {
                    const eFile = document.getElementById('eFile').files[0];
                    if (!eFile) {
                        alert("è¯·ä¸Šä¼ é—ªçƒä½“å…‰è°±CSVæ–‡ä»¶");
                        return;
                    }
                    eData = await parseCSV(eFile);
                } else {
                    eData = await loadPresetCSV(`Scin/${scinPreset}.csv`);
                }

                // Load SiPM data
                if (sipmPreset === 'custom') {
                    const aFile = document.getElementById('aFile').files[0];
                    if (!aFile) {
                        alert("è¯·ä¸Šä¼ SiPM PDE CSVæ–‡ä»¶");
                        return;
                    }
                    aData = await parseCSV(aFile);
                } else {
                    aData = await loadPresetCSV(`SiPM/${sipmPreset}.csv`);
                }

                // è½¬æ¢ä¸ºPythonå¯¹è±¡
                const eDataPy = pyodide.toPy(eData);
                const aDataPy = pyodide.toPy(aData);

                // åˆ›å»ºæ–°çš„å‘½åç©ºé—´
                const namespace = pyodide.toPy({
                    e_data: eDataPy,
                    a_data: aDataPy
                });

                // è¿è¡ŒPythonä»£ç 
                const pyResult = await pyodide.runPythonAsync(`
import numpy as np
import matplotlib.pyplot as plt

# ä»å‘½åç©ºé—´è·å–æ•°æ®
e_array = np.array(e_data, dtype=float)
a_array = np.array(a_data, dtype=float)

# ç¡®ä¿äºŒç»´æ•°ç»„ç»“æ„
if e_array.ndim == 1:
    e_array = e_array.reshape(-1, 2)
if a_array.ndim == 1:
    a_array = a_array.reshape(-1, 2)
e_array = e_array[e_array[:, 0].argsort()]
a_array = a_array[a_array[:, 0].argsort()]

# è®¡ç®—PDE
def cal_area(data):
    try:
        return np.trapz(data[:,1], data[:,0])
    except AttributeError:
        # For newer numpy versions
        return np.trapezoid(data[:,1], data[:,0])

def cal_pde(em, ab):
    area = cal_area(em)
    em_inter = np.interp(ab[:,0], xp=em[:,0], fp=em[:,1])
    try:
        pde = np.trapz(em_inter*ab[:,1]/area, ab[:,0])
    except AttributeError:
        pde = np.trapezoid(em_inter*ab[:,1]/area, ab[:,0])
    return pde, em_inter

pde_value, em_interpolated = cal_pde(e_array, a_array)

# è®¡ç®—å·ç§¯ç»“æœï¼ˆå½’ä¸€åŒ–çš„å‘å°„å…‰è°±ä¸PDEçš„ä¹˜ç§¯ï¼‰
area_emission = cal_area(e_array)
convolution_result = em_interpolated * a_array[:,1] / area_emission

# ç»˜å›¾ - åˆ›å»ºæ›´è¯¦ç»†çš„å¯è§†åŒ–
fig = plt.figure(figsize=(12, 8))

# ç¬¬ä¸€ä¸ªå­å›¾ï¼šåŸå§‹å…‰è°±
ax1 = plt.subplot(2, 1, 1)
ax1_twin = ax1.twinx()

line1 = ax1_twin.plot(e_array[:,0], e_array[:,1], color="red", linewidth=2, label="å‘å°„å…‰è°± (Emission)", alpha=0.8)
line2 = ax1.plot(a_array[:,0], a_array[:,1]*100, color="green", linewidth=2, label="SiPM PDE (%)", alpha=0.8)

ax1.set_xlabel("æ³¢é•¿ Wavelength (nm)", fontsize=12)
ax1.set_ylabel("SiPM PDE (%)", fontsize=12, color="green")
ax1_twin.set_ylabel("å‘å°„å¼ºåº¦ (a.u.)", fontsize=12, color="red")
ax1.tick_params(axis='y', labelcolor='green')
ax1_twin.tick_params(axis='y', labelcolor='red')
ax1.set_title("é—ªçƒä½“å‘å°„å…‰è°±ä¸SiPMå…‰ç”µæ¢æµ‹æ•ˆç‡", fontsize=14, fontweight='bold')
ax1.grid(True, alpha=0.3)

lines = line1 + line2
labels = [l.get_label() for l in lines]
ax1.legend(lines, labels, loc='upper left', framealpha=0.9)

# ç¬¬äºŒä¸ªå­å›¾ï¼šå·ç§¯ç»“æœ
ax2 = plt.subplot(2, 1, 2)
line3 = ax2.plot(a_array[:,0], convolution_result, color="purple", linewidth=2, label="å·ç§¯ç»“æœ (Convolution)", alpha=0.8)
ax2.fill_between(a_array[:,0], 0, convolution_result, color="purple", alpha=0.3)

ax2.set_xlabel("æ³¢é•¿ Wavelength (nm)", fontsize=12)
ax2.set_ylabel("å·ç§¯å¼ºåº¦ (a.u.)", fontsize=12)
ax2.set_title(f"å½’ä¸€åŒ–å·ç§¯ç»“æœ - PDE = {pde_value:.4f}", fontsize=14, fontweight='bold')
ax2.grid(True, alpha=0.3)
ax2.legend(loc='upper right', framealpha=0.9)

plt.tight_layout()

# ç”Ÿæˆå›¾ç‰‡
from io import BytesIO
buf = BytesIO()
plt.savefig(buf, format='png', dpi=100, bbox_inches='tight')
plt.close()
buf.seek(0)
image_data = buf.read().hex()

{'pde': pde_value, 'image': image_data}
                `, { globals: namespace });
                const result = pyResult.toJs();
                
                // Hide loading
                document.getElementById('loading').classList.remove('active');
                document.getElementById('calcButton').disabled = false;
                
                // æ˜¾ç¤ºç»“æœ
                document.getElementById('pdeResult').textContent = result.get("pde").toFixed(4);
                document.getElementById('resultSection').style.display = 'block';
                
                // æ˜¾ç¤ºå›¾åƒ
                const img = new Image();
                img.src = 'data:image/png;base64,' + hexToBase64(result.get("image"));
                const plotDiv = document.getElementById('plot');
                plotDiv.innerHTML = '<h3>ğŸ“ˆ åˆ†æç»“æœ</h3>';
                plotDiv.appendChild(img);

            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('calcButton').disabled = false;
                alert(`å¤„ç†é”™è¯¯: ${error.message || error}`);
                console.error(error);
            }
        }

        async function parseCSV(file) {
            const text = await file.text();
            return text.split('\n')
                .map(line => line.trim())
                .filter(line => line)
                .map(line => line.split(',').map(v => parseFloat(v.trim())))
                .filter(arr => arr.length === 2 && !isNaN(arr[0]) && !isNaN(arr[1]));
        }

        function hexToBase64(hexString) {
            return btoa(String.fromCharCode.apply(null, 
                hexString.match(/\w{2}/g).map(byte => parseInt(byte, 16))
            ));
        }
    </script>
</body>
</html>
