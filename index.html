<!DOCTYPE html>
<html>
<head>
    <title>PDEåˆ†æå·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 30px; 
            background: linear-gradient(to bottom, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { 
            color: #2c3e50; 
            text-align: center; 
            margin-bottom: 30px;
            font-size: 2em;
        }
        .input-section { 
            margin: 30px 0; 
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        label { 
            font-weight: 600; 
            margin-bottom: 8px; 
            color: #495057;
            display: block;
        }
        select, input[type="file"] {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
            background: white;
        }
        select:focus, input[type="file"]:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }
        .button-container {
            text-align: center;
            margin: 30px 0;
        }
        button { 
            padding: 12px 40px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            border: none; 
            border-radius: 25px; 
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        button:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .result-section {
            margin: 30px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 8px;
            color: white;
            text-align: center;
        }
        .result { 
            font-size: 1.5em; 
            font-weight: 600;
        }
        #pdeResult {
            font-size: 1.8em;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        #plot { 
            margin-top: 30px; 
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        #plot img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .info-text {
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 5px;
        }
        h3 {
            color: #495057;
            margin-bottom: 15px;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #667eea;
            font-weight: 600;
        }
        .loading.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ é—ªçƒä½“ä¸SiPMçš„PDEåˆ†æå·¥å…·</h1>
        
        <div class="input-section">
            <h3>ğŸ“Š æ•°æ®è¾“å…¥é…ç½®</h3>
            <div class="input-row">
                <div class="input-group">
                    <label>é—ªçƒä½“å‘å°„å…‰è°± (Scintillator Emission):</label>
                    <select id="scinPreset" onchange="updateScinSource()">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                    <input type="file" id="eFile" accept=".csv" style="display:none; margin-top: 10px;">
                    <div class="info-text">é€‰æ‹©é¢„è®¾é—ªçƒä½“æˆ–ä¸Šä¼ CSVæ–‡ä»¶</div>
                </div>
                
                <div class="input-group">
                    <label>SiPMå…‰ç”µæ¢æµ‹æ•ˆç‡ (SiPM PDE):</label>
                    <select id="sipmPreset" onchange="updateSipmSource()">
                        <option value="">åŠ è½½ä¸­...</option>
                    </select>
                    <input type="file" id="aFile" accept=".csv" style="display:none; margin-top: 10px;">
                    <div class="info-text">é€‰æ‹©é¢„è®¾SiPMæˆ–ä¸Šä¼ CSVæ–‡ä»¶</div>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button onclick="processData()" id="calcButton">ğŸ§® è®¡ç®—å¹¶å¯è§†åŒ–</button>
        </div>
        
        <div class="loading" id="loading">
            â³ æ­£åœ¨è®¡ç®—ä¸­...
        </div>
        
        <div class="result-section" style="display:none;" id="resultSection">
            <div class="result">
                å…‰ç”µæ¢æµ‹æ•ˆç‡ï¼ˆPDEï¼‰: <span id="pdeResult">--</span>
            </div>
        </div>
        
        <div id="plot"></div>
    </div>

    <script>
        let pyodide;
        let pyodideReady = false;
        let presetsConfig = null;
        
        // Load presets configuration from JSON
        async function loadPresetsConfig() {
            try {
                const response = await fetch('presets.json');
                if (!response.ok) {
                    throw new Error('Failed to load presets configuration');
                }
                presetsConfig = await response.json();
                populateDropdowns();
            } catch (error) {
                console.error('Error loading presets:', error);
                alert('æ— æ³•åŠ è½½é¢„è®¾é…ç½®æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥ presets.json æ˜¯å¦å­˜åœ¨');
            }
        }
        
        // Populate dropdowns from JSON config
        function populateDropdowns() {
            if (!presetsConfig) return;
            
            // Populate scintillator dropdown
            const scinSelect = document.getElementById('scinPreset');
            scinSelect.innerHTML = '<option value="">é€‰æ‹©é¢„è®¾...</option>';
            presetsConfig.scintillators.forEach(scin => {
                const option = document.createElement('option');
                option.value = scin.id;
                option.textContent = scin.name;
                option.title = scin.description;
                scinSelect.appendChild(option);
            });
            const customScin = document.createElement('option');
            customScin.value = 'custom';
            customScin.textContent = 'ä¸Šä¼ è‡ªå®šä¹‰æ–‡ä»¶...';
            scinSelect.appendChild(customScin);
            
            // Populate SiPM dropdown
            const sipmSelect = document.getElementById('sipmPreset');
            sipmSelect.innerHTML = '<option value="">é€‰æ‹©é¢„è®¾...</option>';
            presetsConfig.sipms.forEach(sipm => {
                const option = document.createElement('option');
                option.value = sipm.id;
                option.textContent = sipm.name;
                option.title = sipm.description;
                sipmSelect.appendChild(option);
            });
            const customSipm = document.createElement('option');
            customSipm.value = 'custom';
            customSipm.textContent = 'ä¸Šä¼ è‡ªå®šä¹‰æ–‡ä»¶...';
            sipmSelect.appendChild(customSipm);
        }
        
        async function setupPyodide() {
            try {
                document.getElementById('calcButton').disabled = true;
                document.getElementById('calcButton').textContent = 'â³ åˆå§‹åŒ–Pythonç¯å¢ƒ...';
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
                });
                await pyodide.loadPackage(["numpy"]);
                pyodideReady = true;
                document.getElementById('calcButton').disabled = false;
                document.getElementById('calcButton').textContent = 'ğŸ§® è®¡ç®—å¹¶å¯è§†åŒ–';
            } catch (error) {
                alert('åˆå§‹åŒ–Pythonç¯å¢ƒå¤±è´¥: ' + error);
            }
        }
        
        // Load presets and setup Pyodide on page load
        Promise.all([loadPresetsConfig(), setupPyodide()]).catch(error => {
            console.error('Initialization error:', error);
            alert('åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        });


        function updateScinSource() {
            const preset = document.getElementById('scinPreset').value;
            const fileInput = document.getElementById('eFile');
            if (preset === 'custom') {
                fileInput.style.display = 'block';
            } else {
                fileInput.style.display = 'none';
            }
        }

        function updateSipmSource() {
            const preset = document.getElementById('sipmPreset').value;
            const fileInput = document.getElementById('aFile');
            if (preset === 'custom') {
                fileInput.style.display = 'block';
            } else {
                fileInput.style.display = 'none';
            }
        }

        function getPresetPath(type, id) {
            if (!presetsConfig) return null;
            const presets = type === 'scintillator' ? presetsConfig.scintillators : presetsConfig.sipms;
            const preset = presets.find(p => p.id === id);
            return preset ? preset.file : null;
        }

        async function parseCSVText(text) {
            return text.split('\n')
                .map(line => line.trim())
                .filter(line => line && line.length > 0)
                .map(line => line.split(',').map(v => parseFloat(v.trim())))
                .filter(arr => arr.length === 2 && !isNaN(arr[0]) && !isNaN(arr[1]));
        }

        async function loadPresetCSV(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const text = await response.text();
                return parseCSVText(text);
            } catch (error) {
                throw new Error(`åŠ è½½é¢„è®¾æ–‡ä»¶å¤±è´¥ (${path}): ${error.message}`);
            }
        }

        async function processData() {
            if (!pyodideReady) {
                alert("Pythonç¯å¢ƒå°šæœªå‡†å¤‡å¥½ï¼Œè¯·ç¨å€™...");
                return;
            }

            const scinPreset = document.getElementById('scinPreset').value;
            const sipmPreset = document.getElementById('sipmPreset').value;
            
            if (!scinPreset || !sipmPreset) {
                alert("è¯·é€‰æ‹©é—ªçƒä½“å’ŒSiPMæ•°æ®æº");
                return;
            }

            // Validate custom file uploads
            if (scinPreset === 'custom' && !document.getElementById('eFile').files[0]) {
                alert("è¯·ä¸Šä¼ é—ªçƒä½“å…‰è°±CSVæ–‡ä»¶");
                return;
            }
            
            if (sipmPreset === 'custom' && !document.getElementById('aFile').files[0]) {
                alert("è¯·ä¸Šä¼ SiPM PDE CSVæ–‡ä»¶");
                return;
            }

            // Show loading
            document.getElementById('loading').classList.add('active');
            document.getElementById('calcButton').disabled = true;
            document.getElementById('resultSection').style.display = 'none';

            try {
                let eData, aData;

                // Load scintillator data
                if (scinPreset === 'custom') {
                    const eFile = document.getElementById('eFile').files[0];
                    eData = await parseCSV(eFile);
                } else {
                    // Get path from JSON config
                    const presetPath = getPresetPath('scintillator', scinPreset);
                    if (!presetPath) {
                        throw new Error(`Invalid scintillator preset: ${scinPreset}`);
                    }
                    eData = await loadPresetCSV(presetPath);
                }

                // Load SiPM data
                if (sipmPreset === 'custom') {
                    const aFile = document.getElementById('aFile').files[0];
                    aData = await parseCSV(aFile);
                } else {
                    // Get path from JSON config
                    const presetPath = getPresetPath('sipm', sipmPreset);
                    if (!presetPath) {
                        throw new Error(`Invalid SiPM preset: ${sipmPreset}`);
                    }
                    aData = await loadPresetCSV(presetPath);
                }

                // è½¬æ¢ä¸ºPythonå¯¹è±¡
                const eDataPy = pyodide.toPy(eData);
                const aDataPy = pyodide.toPy(aData);

                // åˆ›å»ºæ–°çš„å‘½åç©ºé—´
                const namespace = pyodide.toPy({
                    e_data: eDataPy,
                    a_data: aDataPy
                });

                // è¿è¡ŒPythonä»£ç è¿›è¡Œè®¡ç®—
                const pyResult = await pyodide.runPythonAsync(`
import numpy as np

# ä»å‘½åç©ºé—´è·å–æ•°æ®
e_array = np.array(e_data, dtype=float)
a_array = np.array(a_data, dtype=float)

# ç¡®ä¿äºŒç»´æ•°ç»„ç»“æ„
if e_array.ndim == 1:
    e_array = e_array.reshape(-1, 2)
if a_array.ndim == 1:
    a_array = a_array.reshape(-1, 2)
e_array = e_array[e_array[:, 0].argsort()]
a_array = a_array[a_array[:, 0].argsort()]

# è®¡ç®—PDE
def cal_area(data):
    # Use hasattr to check for numpy version compatibility
    if hasattr(np, 'trapz'):
        return np.trapz(data[:,1], data[:,0])
    else:
        return np.trapezoid(data[:,1], data[:,0])

def cal_pde(em, ab):
    area = cal_area(em)
    em_inter = np.interp(ab[:,0], xp=em[:,0], fp=em[:,1])
    if hasattr(np, 'trapz'):
        pde = np.trapz(em_inter*ab[:,1]/area, ab[:,0])
    else:
        pde = np.trapezoid(em_inter*ab[:,1]/area, ab[:,0])
    return pde, em_inter

pde_value, em_interpolated = cal_pde(e_array, a_array)

# è®¡ç®—å·ç§¯ç»“æœï¼ˆå½’ä¸€åŒ–çš„å‘å°„å…‰è°±ä¸PDEçš„ä¹˜ç§¯ï¼‰
area_emission = cal_area(e_array)
convolution_result = em_interpolated * a_array[:,1] / area_emission

# è¿”å›è®¡ç®—ç»“æœ
{
    'pde': pde_value,
    'e_wavelength': e_array[:,0].tolist(),
    'e_intensity': e_array[:,1].tolist(),
    'a_wavelength': a_array[:,0].tolist(),
    'a_pde': a_array[:,1].tolist(),
    'conv_wavelength': a_array[:,0].tolist(),
    'conv_result': convolution_result.tolist()
}
                `, { globals: namespace });
                const result = pyResult.toJs();
                
                // Hide loading
                document.getElementById('loading').classList.remove('active');
                document.getElementById('calcButton').disabled = false;
                
                // æ˜¾ç¤ºç»“æœ
                const pdeValue = result.get("pde");
                document.getElementById('pdeResult').textContent = pdeValue.toFixed(4);
                document.getElementById('resultSection').style.display = 'block';
                
                // ä½¿ç”¨Plotlyåˆ›å»ºå›¾è¡¨
                const plotDiv = document.getElementById('plot');
                plotDiv.innerHTML = '<h3>ğŸ“ˆ åˆ†æç»“æœ</h3><div id="plotly-chart"></div>';
                
                // å‡†å¤‡æ•°æ®
                const eWavelength = Array.from(result.get("e_wavelength"));
                const eIntensity = Array.from(result.get("e_intensity"));
                const aWavelength = Array.from(result.get("a_wavelength"));
                const aPde = Array.from(result.get("a_pde"));
                const convWavelength = Array.from(result.get("conv_wavelength"));
                const convResult = Array.from(result.get("conv_result"));
                
                // åˆ›å»ºåŒyè½´å›¾è¡¨å’Œå·ç§¯ç»“æœå›¾
                const trace1 = {
                    x: eWavelength,
                    y: eIntensity,
                    name: 'å‘å°„å…‰è°± (Emission)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'red', width: 2 },
                    yaxis: 'y2'
                };
                
                const trace2 = {
                    x: aWavelength,
                    y: aPde.map(v => v * 100),
                    name: 'SiPM PDE (%)',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: 'green', width: 2 }
                };
                
                const trace3 = {
                    x: convWavelength,
                    y: convResult,
                    name: 'å·ç§¯ç»“æœ (Convolution)',
                    type: 'scatter',
                    mode: 'lines',
                    fill: 'tozeroy',
                    line: { color: 'purple', width: 2 },
                    fillcolor: 'rgba(128, 0, 128, 0.3)'
                };
                
                // åˆ›å»ºå®Œæ•´çš„Plotlyå¸ƒå±€ï¼ˆåŒå­å›¾ï¼‰
                const allTraces = [
                    { ...trace1, xaxis: 'x', yaxis: 'y2' },
                    { ...trace2, xaxis: 'x', yaxis: 'y' },
                    { ...trace3, xaxis: 'x2', yaxis: 'y3' }
                ];
                
                const layout = {
                    title: {
                        text: 'é—ªçƒä½“ä¸SiPMçš„PDEåˆ†æ',
                        font: { size: 18, family: 'Arial, sans-serif' }
                    },
                    // ç¬¬ä¸€ä¸ªå­å›¾çš„xè½´
                    xaxis: {
                        title: 'æ³¢é•¿ Wavelength (nm)',
                        domain: [0, 1],
                        anchor: 'y',
                        showgrid: true
                    },
                    // ç¬¬ä¸€ä¸ªå­å›¾çš„å·¦yè½´ (SiPM PDE)
                    yaxis: {
                        title: 'SiPM PDE (%)',
                        domain: [0.55, 1],
                        titlefont: { color: 'green' },
                        tickfont: { color: 'green' },
                        showgrid: true
                    },
                    // ç¬¬ä¸€ä¸ªå­å›¾çš„å³yè½´ (å‘å°„å…‰è°±)
                    yaxis2: {
                        title: 'å‘å°„å¼ºåº¦ (a.u.)',
                        overlaying: 'y',
                        side: 'right',
                        titlefont: { color: 'red' },
                        tickfont: { color: 'red' }
                    },
                    // ç¬¬äºŒä¸ªå­å›¾çš„xè½´
                    xaxis2: {
                        title: 'æ³¢é•¿ Wavelength (nm)',
                        domain: [0, 1],
                        anchor: 'y3',
                        showgrid: true
                    },
                    // ç¬¬äºŒä¸ªå­å›¾çš„yè½´ (å·ç§¯)
                    yaxis3: {
                        title: 'å·ç§¯å¼ºåº¦ (a.u.)',
                        domain: [0, 0.45],
                        showgrid: true
                    },
                    annotations: [{
                        text: `PDE = ${pdeValue.toFixed(4)}`,
                        xref: 'paper',
                        yref: 'paper',
                        x: 0.5,
                        y: -0.05,
                        xanchor: 'center',
                        showarrow: false,
                        font: { size: 16, color: 'purple', weight: 'bold' }
                    }],
                    height: 800,
                    showlegend: true,
                    legend: { x: 0.02, y: 0.98 },
                    font: { family: 'Arial, sans-serif' },
                    hovermode: 'x unified'
                };
                
                // ä¸€æ¬¡æ€§åˆ›å»ºæ‰€æœ‰å›¾è¡¨
                Plotly.newPlot('plotly-chart', allTraces, layout, { responsive: true });

            } catch (error) {
                document.getElementById('loading').classList.remove('active');
                document.getElementById('calcButton').disabled = false;
                alert(`å¤„ç†é”™è¯¯: ${error.message || error}`);
                console.error(error);
            }
        }

        async function parseCSV(file) {
            const text = await file.text();
            return parseCSVText(text);
        }
    </script>
</body>
</html>
